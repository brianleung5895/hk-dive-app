<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HK Dive Smart Master V6.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: #f8fafc; margin: 0; overflow: hidden; color: #334155; }
        [v-cloak] { display: none; }
        #map { position: absolute; inset: 0; z-index: 1; filter: saturate(0.8) brightness(1.05); }
        
        /* Êá∏ÊµÆÂç°Áâá (Êó•Á≥ªÈ¢®Ê†º) */
        .glass-panel {
            background: rgba(255, 255, 255, 0.96); backdrop-filter: blur(12px);
            border-radius: 24px 24px 0 0; box-shadow: 0 -10px 40px rgba(0,0,0,0.06);
            position: absolute; bottom: 0; left: 0; right: 0; z-index: 900;
            padding: 24px; transform: translateY(110%); transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .glass-panel.active { transform: translateY(0); }

        /* AM/PM È†êÊ∏¨ÂçÄÂ°ä */
        .time-card { border-radius: 12px; padding: 10px; position: relative; border: 1px solid transparent; }
        .time-card.am { background: #fff7ed; border-color: #ffedd5; }
        .time-card.pm { background: #eff6ff; border-color: #dbeafe; }
        .time-badge { position: absolute; top: -8px; left: 8px; font-size: 10px; padding: 0 6px; background: white; border-radius: 4px; font-weight: bold; }
        .time-badge.am { color: #f97316; border: 1px solid #ffedd5; }
        .time-badge.pm { color: #3b82f6; border: 1px solid #dbeafe; }

        /* È†ÇÈÉ®ËàáÊåâÈàï */
        .search-box { position: absolute; top: 16px; left: 16px; right: 16px; background: rgba(255,255,255,0.92); backdrop-filter: blur(8px); border-radius: 12px; padding: 10px 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); z-index: 800; display: flex; align-items: center; }
        .fab-group { position: absolute; bottom: 30px; right: 20px; display: flex; gap: 10px; z-index: 800; }
        .fab { width: 44px; height: 44px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08); color: #94a3b8; transition: 0.3s; }
        .fab.active { background: #0ea5e9; color: white; transform: translateY(-3px); }

        /* ÂãïÁï´ */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body>

<div id="app" v-cloak>
    <transition name="fade">
        <div v-if="isLoading" class="fixed inset-0 z-[3000] bg-white/95 flex flex-col items-center justify-center">
            <div class="w-8 h-8 border-4 border-gray-100 border-t-sky-400 rounded-full animate-spin"></div>
            <div class="mt-3 text-xs text-gray-400 tracking-widest font-medium">SYNCING OCEAN DATA...</div>
        </div>
    </transition>

    <div id="map"></div>

    <div class="search-box" v-if="currentTab==='map'">
        <i class="fa-solid fa-magnifying-glass text-gray-300 mr-3"></i>
        <input v-model="search" class="flex-1 bg-transparent outline-none text-sm text-gray-600" placeholder="ÊêúÂ∞ãÊΩõÈªû...">
        <div class="pl-3 border-l border-gray-200 text-xs font-bold text-gray-500">{{ weather.temp }}¬∞C</div>
    </div>

    <div v-if="search && currentTab==='map'" class="absolute top-16 left-4 right-4 z-50 bg-white rounded-xl shadow-lg max-h-60 overflow-y-auto">
        <div v-for="s in filteredSites" @click="focus(s)" class="p-3 border-b hover:bg-gray-50 cursor-pointer flex justify-between">
            <span class="text-sm font-bold text-gray-700">{{ s.name }}</span>
        </div>
        <div v-if="filteredSites.length===0" @click="addSiteAI" class="p-4 text-center cursor-pointer text-sky-500 hover:bg-sky-50">
            <p class="text-xs font-bold"><i class="fa-solid fa-bolt mr-1"></i>AI ÂÖ®Á∂≤ÊêúÂ∞ã‰∏¶Êñ∞Â¢û</p>
        </div>
    </div>

    <div :class="['glass-panel', selected ? 'active' : '']">
        <div v-if="selected">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">{{ selected.name }}</h2>
                    <p class="text-[10px] text-gray-400 mt-1">Êõ¥Êñ∞: {{ formatTime(selected.upd) }}</p>
                </div>
                <button @click="selected=null" class="w-8 h-8 rounded-full bg-gray-50 text-gray-400"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="flex gap-3 text-center mb-6">
                <div class="flex-1 bg-gray-50 rounded-xl p-2"><div class="text-[10px] text-gray-400">Ê∑±Â∫¶</div><div class="font-bold text-sm text-gray-700">{{ selected.depth }}</div></div>
                <div class="flex-1 bg-gray-50 rounded-xl p-2"><div class="text-[10px] text-gray-400">Ê∞¥ÊµÅ</div><div class="font-bold text-sm text-gray-700">{{ selected.flow }}</div></div>
            </div>

            <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3">‰ªäÊó•È†êÂ†± (09:00 - 16:00)</h3>
            <div class="flex gap-3 mb-4">
                <div class="time-card am flex-1">
                    <div class="time-badge am">AM Êó©ÊΩõ</div>
                    <p class="text-xs text-gray-600 mt-1 font-medium">{{ selected.am }}</p>
                </div>
                <div class="time-card pm flex-1">
                    <div class="time-badge pm">PM ÂçàÊΩõ</div>
                    <p class="text-xs text-gray-600 mt-1 font-medium">{{ selected.pm }}</p>
                </div>
            </div>

            <div class="bg-gray-50 p-3 rounded-xl text-xs text-gray-500 leading-relaxed">
                <i class="fa-solid fa-robot text-sky-400 mr-1"></i> {{ selected.note }}
            </div>
        </div>
    </div>

    <div class="fab-group" v-if="!selected">
        <div @click="tab='map'" :class="['fab', tab==='map'?'active':'']"><i class="fa-solid fa-map-location-dot"></i></div>
        <div @click="tab='log'" :class="['fab', tab==='log'?'active':'']"><i class="fa-solid fa-book"></i></div>
    </div>

    <div v-if="tab==='log'" class="absolute inset-0 bg-gray-50 z-[850] p-5 overflow-y-auto">
        <div class="flex justify-between items-center mb-6 mt-12">
            <h2 class="text-2xl font-bold text-gray-800">Dive Log</h2>
            <button @click="showLogModal=true" class="bg-gray-900 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-lg">Êñ∞Â¢û</button>
        </div>
        <div class="space-y-3 pb-20">
            <div v-for="l in logs" :key="l.id" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex justify-between font-bold text-gray-700"><span>{{ l.site }}</span><span class="text-sky-500">{{ l.vis }}m</span></div>
                <div class="text-xs text-gray-400 mt-1">{{ l.date }}</div>
            </div>
        </div>
    </div>

    <div v-if="showLogModal" class="fixed inset-0 z-[3000] bg-black/60 flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4">Êñ∞Â¢ûÁ¥ÄÈåÑ</h3>
            <input v-model="newLog.site" class="w-full bg-gray-50 p-3 rounded-xl text-sm mb-3 outline-none" placeholder="ÊΩõÈªû">
            <div class="flex gap-3 mb-3"><input v-model="newLog.vis" type="number" class="flex-1 bg-gray-50 p-3 rounded-xl text-sm outline-none" placeholder="ËÉΩË¶ãÂ∫¶"><input v-model="newLog.temp" type="number" class="flex-1 bg-gray-50 p-3 rounded-xl text-sm outline-none" placeholder="Ê∞¥Ê∫´"></div>
            <div class="flex gap-3"><button @click="saveLog" class="flex-1 bg-sky-500 text-white py-3 rounded-xl font-bold">‰øùÂ≠ò</button><button @click="showLogModal=false" class="flex-1 bg-gray-100 text-gray-400 font-bold rounded-xl">ÂèñÊ∂à</button></div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const { createApp, ref, computed, onMounted } = Vue;
    // üî¥ Â°´ÂÖ•ÊÇ®ÁöÑ GAS Á∂≤ÂùÄ
    const API_URL = "https://script.google.com/macros/s/AKfycbxVy_lw6YVRIwG_3_L86ZzAs-iSqLMTQpZIOzCIHRMzz98wrTDt1JTTnA8L4-Q3TUtkXw/exec"; 

    createApp({
        setup() {
            const tab = ref('map');
            const isLoading = ref(true);
            const search = ref('');
            const weather = ref({});
            const sites = ref([]);
            const logs = ref(JSON.parse(localStorage.getItem('logs')||'[]'));
            const selected = ref(null);
            const showLogModal = ref(false);
            const newLog = ref({site:'', vis:'', temp:''});
            let map;

            onMounted(async () => {
                map = L.map('map', {zoomControl:false}).setView([22.38, 114.32], 10);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
                
                try {
                    const res = await fetch(`${API_URL}?action=init`);
                    const d = await res.json();
                    if(d.status==='success') {
                        sites.value = d.sites;
                        weather.value = d.weather;
                        sites.value.forEach(s => {
                            L.circleMarker([s.lat, s.lng], {radius:6, fillColor:'#0ea5e9', color:'white', weight:2, fillOpacity:1})
                             .addTo(map).on('click', ()=>selected.value=s);
                        });
                    }
                } catch(e){} finally { isLoading.value = false; }
            });

            const addSiteAI = async () => {
                const name = search.value;
                if(!name) return;
                isLoading.value = true;
                search.value = '';
                try {
                    // È†êË®≠ÂùêÊ®ô, ÂØ¶ÈöõÂèØÂä† navigator.geolocation
                    const res = await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'addSite', name, lat:22.35, lng:114.30})});
                    const d = await res.json();
                    if(d.status==='success') {
                        const ns = {id:Date.now(), name, lat:22.35, lng:114.30, ...d.data};
                        sites.value.push(ns);
                        selected.value = ns;
                    }
                } catch(e){} finally { isLoading.value = false; }
            };

            const saveLog = () => {
                const l = {id:Date.now(), date:new Date().toLocaleDateString(), ...newLog.value};
                logs.value.unshift(l);
                localStorage.setItem('logs', JSON.stringify(logs.value));
                showLogModal.value = false;
                fetch(API_URL, {method:'POST', body:JSON.stringify({action:'log', ...l})});
            };

            const filteredSites = computed(()=>search.value ? sites.value.filter(s=>s.name.includes(search.value)) : []);
            const focus = (s) => { selected.value=s; map.setView([s.lat, s.lng], 14); search.value=''; };
            const formatTime = (t) => t ? new Date(t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : 'ÂâõÂâõ';

            return { tab, isLoading, search, weather, sites, logs, selected, showLogModal, newLog, filteredSites, focus, addSiteAI, saveLog, formatTime };
        }
    }).mount('#app');
</script>
</body>
</html>
